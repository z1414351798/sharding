<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.z.sharding.mapper.OrderMapper">

    <resultMap id="OrderItemResultMap" type="com.z.sharding.pojo.OrderItem">
        <id     property="itemId" column="item_id"/>
        <result property="orderId" column="order_id"/>
        <result property="userId" column="user_id"/>
        <result property="goodId" column="good_id"/>
        <result property="goodNameSnapshot" column="good_name_snapshot"/>
        <result property="goodPriceSnapshot" column="good_price_snapshot"/>
        <result property="goodImageSnapshot" column="good_image_snapshot"/>
        <result property="attributesSnapshotJson" column="attributes_snapshot_json"/>
        <result property="quantity" column="quantity"/>
        <result property="createTime" column="item_create_time"/>
        <result property="version" column="version"/>
    </resultMap>

    <resultMap id="OrderResultMap" type="com.z.sharding.pojo.Order">
        <id property="orderId" column="order_id"/>
        <result property="userId" column="user_id"/>
        <result property="regionCode" column="region_code"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="version" column="version"/>
        <!-- 映射 OrderItem 列表 -->
        <collection property="orderItemList"
                    resultMap="OrderItemResultMap"/>
    </resultMap>


    <insert id="insert" parameterType="com.z.sharding.pojo.Order">
        INSERT INTO t_order(order_id, user_id, region_code , total_amount, status, create_time, update_time, version)
        VALUES (#{orderId}, #{userId}, #{regionCode}, #{totalAmount}, #{status}, #{createTime}, #{updateTime}, #{version})
    </insert>

    <select id="selectByUserId"
            parameterType="String"
            resultMap="OrderResultMap">

        SELECT
        o.order_id,
        o.user_id,
        o.region_code,
        o.total_amount,
        o.status,
        o.create_time,
        o.update_time,
        o.version,

        oi.item_id,
        oi.order_id,
        oi.user_id,
        oi.good_id,
        oi.good_name_snapshot,
        oi.good_price_snapshot,
        oi.good_image_snapshot,
        oi.attributes_snapshot_json,
        oi.quantity,
        oi.create_time AS item_create_time,
        oi.version


        FROM t_order o
        LEFT JOIN t_order_item oi ON o.order_id = oi.order_id
        WHERE o.user_id = #{userId}
        ORDER BY o.order_id, oi.item_id;

    </select>



    <select id="selectByOrderId"
            parameterType="long"
            resultMap="OrderResultMap">

        SELECT
        o.order_id,
        o.user_id,
        o.region_code,
        o.total_amount,
        o.status,
        o.create_time,
        o.update_time,
        o.version,

        oi.item_id,
        oi.order_id,
        oi.user_id,
        oi.good_id,
        oi.good_name_snapshot,
        oi.good_price_snapshot,
        oi.good_image_snapshot,
        oi.attributes_snapshot_json,
        oi.quantity,
        oi.create_time AS item_create_time,
        oi.version

        FROM t_order o
        LEFT JOIN t_order_item oi ON o.order_id = oi.order_id
        WHERE o.order_id = #{order_id}
        ORDER BY o.order_id, oi.item_id;

    </select>


    <select id="selectVersion" resultType="long">
        SELECT version FROM t_order WHERE order_id = #{orderId}
    </select>

    <update id="updateOrderWithVersion">
        UPDATE t_order
        <set>
            <if test="order.status != null">
                status = #{order.status},
            </if>
            <if test="order.totalAmount != null">
                total_amount = #{order.totalAmount},
            </if>
            <if test="order.userId != null">
                user_id = #{order.userId},
            </if>
            <if test="order.regionCode != null">
                region_code = #{order.regionCode},
            </if>
            <if test="order.version != null">
                version = #{order.version},
            </if>
            <!-- 自动更新时间 -->
            update_time = NOW()
        </set>
        WHERE order_id = #{order.orderId}
        AND version = #{oldVersion}   <!-- 乐观锁 -->
    </update>


    <update id="updateOrderDynamic" parameterType="com.z.sharding.pojo.Order">
        UPDATE t_order
        <set>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="totalAmount != null">
                total_amount = #{totalAmount},
            </if>
            <if test="userId != null">
                user_id = #{userId},
            </if>
            <if test="regionCode != null">
                region_code = #{regionCode},
            </if>
            <if test="version != null">
                version = #{version},
            </if>
            <!-- 自动更新时间 -->
            update_time = NOW()
        </set>
        WHERE order_id = #{orderId}
    </update>




</mapper>
